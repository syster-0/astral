name: ğŸªŸ æ„å»º WindowsSetup åº”ç”¨

on:
  workflow_dispatch:
  push:  # æ¯æ¬¡ push åˆ°ä»“åº“æ—¶è§¦å‘
    tags:
      - 'v*'   # æŒ‡å®šè§¦å‘åˆ†æ”¯

jobs:
  build:
    runs-on: windows-latest

    # è°ƒæ•´ GITHUB_TOKEN çš„æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
      packages: write
      
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      # å®‰è£… Flutter
      - name: ğŸ¦ å®‰è£… Flutter
        run: |
          echo "æ­£åœ¨å…‹éš† Flutter ç¨³å®šåˆ†æ”¯..."
          git clone https://github.com/flutter/flutter.git -b stable
          echo "æ­£åœ¨å°† Flutter æ·»åŠ åˆ° PATH..."
          echo "$env:GITHUB_WORKSPACE\flutter\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "Flutter å®‰è£…å®Œæˆï¼"

      # å®‰è£… Flutter ä¾èµ–
      - name: ğŸ“¦ å®‰è£… Flutter ä¾èµ–
        run: |
          echo "æ­£åœ¨è·å– Flutter ä¾èµ–..."
          flutter pub get
          echo "Flutter ä¾èµ–å®‰è£…å®Œæˆï¼"

      # ç¼–è¯‘ Flutter Windows åº”ç”¨
      - name: ğŸ› ï¸ ç¼–è¯‘ Flutter Windows åº”ç”¨
        run: |
          echo "æ­£åœ¨ç¼–è¯‘ Flutter Windows Release ç‰ˆæœ¬..."
          flutter build windows --release
          echo "Flutter Windows Release ç¼–è¯‘å®Œæˆï¼"

      # å¤åˆ¶ DLL æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
      - name: ğŸ“‚ å¤åˆ¶ DLL æ–‡ä»¶åˆ° Release ç›®å½•
        run: |
          echo "æ­£åœ¨å¤åˆ¶ DLL æ–‡ä»¶åˆ° Release ç›®å½•..."
          $dllSourceDir = "$env:GITHUB_WORKSPACE\dlls"
          $releaseDir = "$env:GITHUB_WORKSPACE\build\windows\x64\runner\Release"
          Copy-Item -Path "$dllSourceDir\*" -Destination $releaseDir -Recurse -Force
          echo "DLL æ–‡ä»¶å·²å¤åˆ¶åˆ° $releaseDirï¼"

      # å®‰è£… Inno Setup
      - name: ğŸ“¥ å®‰è£… Inno Setup
        run: |
          echo "æ­£åœ¨ä¸‹è½½ Inno Setup..."
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup.exe"
          echo "æ­£åœ¨å®‰è£… Inno Setup..."
          Start-Process -FilePath "innosetup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
          echo "Inno Setup å®‰è£…å®Œæˆï¼"
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # åˆ›å»º Inno Setup è„šæœ¬
      - name: ğŸ“ åˆ›å»º Inno Setup è„šæœ¬
        run: |
          echo "æ­£åœ¨åˆ›å»º Inno Setup è„šæœ¬..."
          $version = "${{ github.ref_name }}" -replace 'v', ''
          if (-not $version) { $version = "1.0.0" }
          
          $scriptContent = @"
          ; Inno Setup è„šæœ¬æ–‡ä»¶
          #define MyAppName "Astral"
          #define MyAppVersion "$version"
          #define MyAppPublisher "Astral Team"
          #define MyAppURL "https://github.com/yourusername/astral"
          #define MyAppExeName "astral.exe"

          [Setup]
          AppId={{GUID-FOR-YOUR-APP}}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          AppSupportURL={#MyAppURL}
          AppUpdatesURL={#MyAppURL}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          OutputDir=$env:GITHUB_WORKSPACE
          OutputBaseFilename=astral-setup-{#MyAppVersion}
          Compression=lzma
          SolidCompression=yes
          WizardStyle=modern

          [Languages]
          Name: "chinese"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

          [Tasks]
          Name: "desktopicon"; Description: "åˆ›å»ºæ¡Œé¢å›¾æ ‡"; GroupDescription: "é™„åŠ å›¾æ ‡:"; Flags: unchecked

          [Files]
          Source: "$env:GITHUB_WORKSPACE\build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "å¯åŠ¨ {#MyAppName}"; Flags: nowait postinstall skipifsilent
          "@

          $scriptContent | Out-File -FilePath "$env:GITHUB_WORKSPACE\setup.iss" -Encoding utf8
          echo "Inno Setup è„šæœ¬å·²åˆ›å»ºï¼"

      # ç¼–è¯‘ Inno Setup å®‰è£…ç¨‹åº
      - name: ğŸ”¨ ç¼–è¯‘ Inno Setup å®‰è£…ç¨‹åº
        run: |
          echo "æ­£åœ¨ç¼–è¯‘ Inno Setup å®‰è£…ç¨‹åº..."
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "$env:GITHUB_WORKSPACE\setup.iss"
          echo "Inno Setup å®‰è£…ç¨‹åºç¼–è¯‘å®Œæˆï¼"

      # ä¸Šä¼  Inno Setup å®‰è£…ç¨‹åºä½œä¸º Artifact
      - name: ğŸ“¤ ä¸Šä¼  Inno Setup å®‰è£…ç¨‹åº
        uses: actions/upload-artifact@v4
        with:
          name: setup
          path: ${{ github.workspace }}/astral-setup-*.exe
          
      # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ–‡ä»¶
      - name: ğŸ“¢ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ github.workspace }}/astral-setup-*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}