name: ğŸ æ„å»º iOS åº”ç”¨

on:
  workflow_dispatch:
  # push:
  #   tags:
  #     - 'v*'   # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    runs-on: macos-latest  # ä½¿ç”¨ 
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: ğŸ¦€ è®¾ç½® Rust å·¥å…·é“¾
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: aarch64-apple-ios  # ä¿®æ”¹ä¸º iOS æ¶æ„

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          brew update
          brew install cmake ninja
          brew install protobuf
          brew install ruby
          brew install cocoapods
          export LDFLAGS="-L/opt/homebrew/opt/ruby/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/ruby/include"

      - name: ğŸ¦ å®‰è£… Flutter
        run: |
          [ ! -d "$HOME/flutter" ] && git clone https://github.com/flutter/flutter.git -b stable $HOME/flutter
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          export PATH="$HOME/flutter/bin:$PATH"
          chmod +x $HOME/flutter/bin/flutter
          flutter --version

      - name: ğŸ¯ å¯ç”¨ iOS æ”¯æŒ
        run: |
          flutter config --enable-ios
          flutter create --platforms=ios .

      - name: ğŸ“š å®‰è£… Flutter ä¾èµ–
        run: |
          flutter precache --ios
          flutter pub get
          cd ios && pod install && cd ..

      - name: ğŸ› ï¸ æ„å»º iOS åº”ç”¨
        run: |
          flutter build ios --release --no-codesign

      - name: ğŸ” è‡ªç­¾åå’Œæ‰“åŒ… IPA
        run: |
          cd ios
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p Payload
          # å¤åˆ¶åº”ç”¨åˆ° Payload ç›®å½•
          cp -r build/Release-iphoneos/Runner.app Payload/
          # åˆ›å»ºè¯ä¹¦å’Œé…ç½®æ–‡ä»¶
          security create-keychain -p github_action build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p github_action build.keychain
          # ç­¾ååº”ç”¨
          /usr/bin/codesign --force --sign "Apple Development" --entitlements Runner/Runner.entitlements Payload/Runner.app
          # æ‰“åŒ… IPA
          zip -r ../release/Astral.ipa Payload
          # æ¸…ç†
          rm -rf Payload
          security delete-keychain build.keychain

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: release/Astral.ipa
          retention-days: 7
