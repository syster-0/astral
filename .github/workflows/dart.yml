name: ğŸš€ å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'åŸºç¡€åˆ†æ”¯ (ä¾‹å¦‚: main)'
        required: true
        default: 'main'
        type: string
      head_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä¾‹å¦‚: develop)'
        required: true
        default: 'develop'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    # è°ƒæ•´ GITHUB_TOKEN çš„æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
      actions: read    # å…è®¸è¯»å–å·¥ä½œæµç¨‹

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿æ¯”è¾ƒåˆ†æ”¯
        
      - name: ğŸ“¦ ä¸‹è½½ armeabi-v7a æ„ä»¶
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: "android-build-armv7.yaml"
          name: app-release-armeabi-v7a
          path: ./downloaded/armeabi-v7a
          search_artifacts: true
          if_no_artifact_found: warn
          
      # ... å…¶ä»–ä¸‹è½½æ­¥éª¤ä¿æŒä¸å˜ ...
          
      - name: ğŸ“ åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "å·²ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./downloaded
          echo "armeabi-v7a æ–‡ä»¶:"
          ls -la ./downloaded/armeabi-v7a || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "arm64-v8a æ–‡ä»¶:"
          ls -la ./downloaded/arm64-v8a || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "æ‰€æœ‰æ¶æ„æ–‡ä»¶:"
          ls -la ./downloaded/all || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "x86_64 æ–‡ä»¶:"
          ls -la ./downloaded/x86_64 || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "Windows æ–‡ä»¶:"
          ls -la ./downloaded/windows || echo "ç›®å½•ä¸å­˜åœ¨"
          
      - name: ğŸ¤– ç”Ÿæˆåˆ†æ”¯å·®å¼‚æäº¤å†…å®¹
        id: generate_changelog
        run: |
          # è·å–ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´çš„æäº¤ä¿¡æ¯
          COMMITS=$(git log --pretty=format:"%h - %s (%an)" ${{ github.event.inputs.base_branch }}..${{ github.event.inputs.head_branch }})
          
          # å°†æäº¤ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶
          echo "$COMMITS" > commits.txt
          
          # å®‰è£… Python å’Œå¿…è¦çš„åº“
          pip install google-generativeai
          
          # åˆ›å»º Python è„šæœ¬ç”Ÿæˆæ›´æ–°æ—¥å¿—
          cat > generate_changelog.py << 'EOF'
          import google.generativeai as genai
          import os
          
          # é…ç½® API å¯†é’¥
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          
          # è¯»å–æäº¤ä¿¡æ¯
          with open('commits.txt', 'r') as f:
              commits = f.read()
          
          # è®¾ç½®æ¨¡å‹å’Œç”Ÿæˆå‚æ•°
          model = genai.GenerativeModel('gemini-1.5-flash')  # ä¿®æ”¹ä¸º Gemini 2.0 Flash
          prompt = f"""
          è¯·æ ¹æ®ä»¥ä¸‹Gitæäº¤è®°å½•ï¼Œç”Ÿæˆä¸€ä»½ç”¨æˆ·å‹å¥½çš„æ›´æ–°æ—¥å¿—ã€‚
          å°†å†…å®¹åˆ†ç±»ä¸º"æ–°åŠŸèƒ½"ã€"æ”¹è¿›"ã€"ä¿®å¤"ç­‰ç±»åˆ«ã€‚
          ä½¿ç”¨ç®€æ´æ˜äº†çš„ä¸­æ–‡æè¿°æ¯é¡¹å˜æ›´ã€‚
          
          æäº¤è®°å½•:
          {commits}
          """
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          response = model.generate_content(prompt)
          
          # ä¿å­˜ç»“æœ
          with open('CHANGELOG.md', 'w') as f:
              f.write("# æ›´æ–°æ—¥å¿—\n\n")
              f.write(response.text)
          EOF
          
          # æ‰§è¡Œ Python è„šæœ¬
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} python generate_changelog.py
          
          # å°†æ›´æ–°æ—¥å¿—å†…å®¹è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          CHANGELOG=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸš€ åˆ›å»ºè‰ç¨¿å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          name: å‘å¸ƒ ${{ github.event.inputs.head_branch }}
          tag_name: release-${{ github.run_number }}
          body: ${{ steps.generate_changelog.outputs.changelog }}
          draft: true  # è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            ./downloaded/armeabi-v7a/*.apk
            ./downloaded/arm64-v8a/*.apk
            ./downloaded/all/*.apk
            ./downloaded/x86_64/*.apk
            ./downloaded/windows/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}