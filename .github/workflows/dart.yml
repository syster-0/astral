name: ğŸš€ å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'åŸºç¡€åˆ†æ”¯ (ä¾‹å¦‚: v0.0.0)'
        required: true
        default: 'v1.'
        type: string
      head_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä¾‹å¦‚: main)'
        required: true
        default: 'main'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    # è°ƒæ•´ GITHUB_TOKEN çš„æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
      actions: read    # å…è®¸è¯»å–å·¥ä½œæµç¨‹

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿æ¯”è¾ƒåˆ†æ”¯
        
      - name: ğŸ“¦ ä¸‹è½½ arm64-v8a æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-arm64.yaml"
          name: astral-arm64-v8a-apk
          path: ./downloaded/arm64-v8a
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/arm64-v8a/* ./downloaded/arm64-v8a/astral-arm64-v8a.apk

      - name: ğŸ“¦ ä¸‹è½½ armeabi-v7a æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-armv7.yaml"
          name: astral-armeabi-v7a-apk
          path: ./downloaded/armeabi-v7a
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/armeabi-v7a/* ./downloaded/armeabi-v7a/astral-armeabi-v7a.apk

      - name: ğŸ“¦ ä¸‹è½½ x86_64 æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-x86_64.yaml"
          name: astral-x86_64-apk
          path: ./downloaded/x86_64
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/x86_64/* ./downloaded/x86_64/astral-x86_64.apk

      - name: ğŸ“¦ ä¸‹è½½ universal æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-all.yaml"
          name: astral-universal-apk
          path: ./downloaded/universal
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/universal/* ./downloaded/universal/astral-universal.apk

      - name: ğŸ“¦ ä¸‹è½½ Windows æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "windows-build.yml"
          name: astral-windows-x64-zip
          path: ./downloaded/windows
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/windows/* ./downloaded/windows/astral-windows-x64-zip.zip
      
      - name: ğŸ“¦ ä¸‹è½½ WindowsSetup æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "windows-build-Setup.yml"
          name: astral-windows-x64-setup
          path: ./downloaded/WindowsSetup
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/WindowsSetup/* ./downloaded/WindowsSetup/astral-windows-x64-setup.exe

      - name: ğŸ“¦ ä¸‹è½½ WindowsSetupCmd æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "windows-build-Setup-cmd.yml"
          name: astral-windows-x64-setup-cmd
          path: ./downloaded/WindowsSetupCmd
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/WindowsSetupCmd/* ./downloaded/WindowsSetupCmd/astral-windows-x64-setup-cmd.exe

      - name: ğŸ“¦ ä¸‹è½½ linux æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: 'linux-build.yaml'
          name: astral-linux-x64-tar
          path: ./downloaded/linux
          search_artifacts: true
          if_no_artifact_found: warn

      - name: ğŸ“ åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "å·²ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./downloaded
          echo "armeabi-v7a æ–‡ä»¶:"
          ls -la ./downloaded/armeabi-v7a || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "arm64-v8a æ–‡ä»¶:"
          ls -la ./downloaded/arm64-v8a || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "æ‰€æœ‰æ¶æ„æ–‡ä»¶:"
          ls -la ./downloaded/all || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "x86_64 æ–‡ä»¶:"
          ls -la ./downloaded/x86_64 || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "Windows æ–‡ä»¶:"
          ls -la ./downloaded/windows || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "WindowsSetup æ–‡ä»¶:"
          ls -la ./downloaded/WindowsSetup || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "Linux æ–‡ä»¶:"
          ls -la ./downloaded/linux || echo "ç›®å½•ä¸å­˜åœ¨"
          
      - name: ğŸ¤– ç”Ÿæˆåˆ†æ”¯å·®å¼‚æäº¤å†…å®¹
        id: generate_changelog
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE }}
        run: |
          # è·å–ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´çš„æäº¤ä¿¡æ¯
          COMMITS=$(git log --pretty=format:"%h - %s (%an)" ${{ github.event.inputs.base_branch }}..${{ github.event.inputs.head_branch }})
          
          # å°†æäº¤ä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶
          echo "$COMMITS" > commits.txt
          
          # å®‰è£… Python å’Œå¿…è¦çš„åº“
          pip install google-generativeai
          
          # åˆ›å»º Python è„šæœ¬ç”Ÿæˆæ›´æ–°æ—¥å¿—
          cat > generate_changelog.py << EOF
          import google.generativeai as genai
          import os
          import sys
          
          try:
              api_key = os.environ.get('GOOGLE_API_KEY')
              if not api_key:
                  print("Error: GOOGLE_API_KEY environment variable not found")
                  sys.exit(1)
                  
              # é…ç½® API å¯†é’¥
              genai.configure(api_key=api_key)
              
              # è¯»å–æäº¤ä¿¡æ¯
              with open('commits.txt', 'r') as f:
                  commits = f.read()
              
              if not commits.strip():
                  print("No commits found between specified branches")
                  with open('CHANGELOG.md', 'w') as f:
                      f.write("# æ›´æ–°æ—¥å¿—\n\næ— æ›´æ–°å†…å®¹")
                  sys.exit(0)
              
              # è®¾ç½®æ¨¡å‹å’Œç”Ÿæˆå‚æ•°
              model = genai.GenerativeModel('gemini-1.5-flash')
              prompt = f"""
              è¯·æ ¹æ®ä»¥ä¸‹Gitæäº¤è®°å½•ç”Ÿæˆè§„èŒƒçš„æ›´æ–°æ—¥å¿—æ–‡æ¡£ï¼š

              ## æäº¤è®°å½•è¯¦æƒ…
              {commits}

              ç”Ÿæˆè¦æ±‚ï¼š
              1. æ ‡é¢˜æ ¼å¼ï¼š
                 # ç‰ˆæœ¬æ›´æ–°æ¦‚è¦ 
                 > ä¸€å¥è¯ç®€è¿°æœ¬æ¬¡æ›´æ–°è¦ç‚¹

              2. å†…å®¹åˆ†ç±»ï¼ˆè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºå’Œå›¾æ ‡ï¼‰ï¼š
                 ## ğŸš€ æ–°å¢åŠŸèƒ½
                 - æ–°åŠŸèƒ½æ¡ç›®1
                 - æ–°åŠŸèƒ½æ¡ç›®2
                 
                 ## ğŸ”§ é—®é¢˜ä¿®å¤
                 - ä¿®å¤å†…å®¹1
                 - ä¿®å¤å†…å®¹2
                 
                 ## ğŸŒŸ åŠŸèƒ½ä¼˜åŒ–
                 - ä¼˜åŒ–å†…å®¹1
                 - ä¼˜åŒ–å†…å®¹2

              3. å†…å®¹è¦æ±‚ï¼š
                 - æ¯ä¸ªæ¡ç›®ä½¿ç”¨ç®€æ´çš„åŠ¨è¯å¼€å¤´
                 - æè¿°è¦å…·ä½“ä¸”æ¸…æ™°
                 - é¿å…æŠ€æœ¯æœ¯è¯­ï¼Œä½¿ç”¨ç”¨æˆ·å‹å¥½çš„è¡¨è¿°
                 - ç›¸ä¼¼æ”¹åŠ¨å½’ç±»åˆå¹¶
              
              4. æ ¼å¼è§„èŒƒï¼š
                 - ä½¿ç”¨ Markdown æ ¼å¼
                 - æ¯ä¸ªåˆ†ç±»ä¸‹ä½¿ç”¨æ— åºåˆ—è¡¨ï¼ˆ-ï¼‰
                 - ä¿æŒç»Ÿä¸€çš„ç¼©è¿›
                 - æ¡ç›®é—´ä¿ç•™é€‚å½“ç©ºè¡Œ
              """
              # ç”Ÿæˆæ›´æ–°æ—¥å¿—
              response = model.generate_content(prompt)
              
              # ä¿å­˜ç»“æœ
              with open('CHANGELOG.md', 'w') as f:
                  f.write("# æ›´æ–°æ—¥å¿—\n\n")
                  f.write(response.text)
                  
          except Exception as e:
              print(f"Error: {str(e)}")
              sys.exit(1)
          EOF
          
          # æ‰§è¡Œ Python è„šæœ¬
          python generate_changelog.py
          
          # å°†æ›´æ–°æ—¥å¿—å†…å®¹è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          CHANGELOG=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸš€ åˆ›å»ºè‰ç¨¿å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          name: å‘å¸ƒ ${{ github.event.inputs.head_branch }}
          tag_name: release-${{ github.run_number }}
          body: ${{ steps.generate_changelog.outputs.changelog }}
          draft: true  # è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            ./downloaded/arm64-v8a/*.apk
            ./downloaded/armeabi-v7a/*.apk
            ./downloaded/x86_64/*.apk
            ./downloaded/universal/*.apk
            ./downloaded/WindowsSetup/*.exe
            ./downloaded/WindowsSetupCmd/*.exe
            ./downloaded/windows/*.zip
            ./downloaded/linux/*.tar.gz
            ./downloaded/linux/*.deb
            ./downloaded/linux/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
