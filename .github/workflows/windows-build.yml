name: ğŸ› ï¸ æ„å»º Windows åº”ç”¨

on:
  workflow_dispatch:
  push:  # æ¯æ¬¡ push åˆ°ä»“åº“æ—¶è§¦å‘
    branches:
      - main  # æŒ‡å®šè§¦å‘åˆ†æ”¯

jobs:
  build:
    runs-on: windows-latest

    # è°ƒæ•´ GITHUB_TOKEN çš„æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
      packages: write
      
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      # å®‰è£… Flutter
      - name: ğŸ¦ å®‰è£… Flutter
        run: |
          echo "æ­£åœ¨å…‹éš† Flutter ç¨³å®šåˆ†æ”¯..."
          git clone https://github.com/flutter/flutter.git -b stable
          echo "æ­£åœ¨å°† Flutter æ·»åŠ åˆ° PATH..."
          echo "$env:GITHUB_WORKSPACE\flutter\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "Flutter å®‰è£…å®Œæˆï¼"

      # å®‰è£… Flutter ä¾èµ–
      - name: ğŸ“¦ å®‰è£… Flutter ä¾èµ–
        run: |
          echo "æ­£åœ¨è·å– Flutter ä¾èµ–..."
          flutter pub get
          echo "Flutter ä¾èµ–å®‰è£…å®Œæˆï¼"

      # ç¼–è¯‘ Flutter Windows åº”ç”¨
      - name: ğŸ› ï¸ ç¼–è¯‘ Flutter Windows åº”ç”¨
        run: |
          echo "æ­£åœ¨ç¼–è¯‘ Flutter Windows Release ç‰ˆæœ¬..."
          flutter build windows --release
          echo "Flutter Windows Release ç¼–è¯‘å®Œæˆï¼"

      # å¤åˆ¶ DLL æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
      - name: ğŸ“‚ å¤åˆ¶ DLL æ–‡ä»¶åˆ° Release ç›®å½•
        run: |
          echo "æ­£åœ¨å¤åˆ¶ DLL æ–‡ä»¶åˆ° Release ç›®å½•..."
          $dllSourceDir = "$env:GITHUB_WORKSPACE\assets\dlls"
          $releaseDir = "$env:GITHUB_WORKSPACE\build\windows\x64\runner\Release"
          Copy-Item -Path "$dllSourceDir\*" -Destination $releaseDir -Recurse -Force
          echo "DLL æ–‡ä»¶å·²å¤åˆ¶åˆ° $releaseDirï¼"

      # åˆ›å»ºæˆ–è·å– Draft Release
      - name: ğŸš€ åˆ›å»ºæˆ–è·å– Draft Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: autobuild  # å›ºå®šæ ‡ç­¾
          release_name: Auto Build
          draft: true  # åˆ›å»ºä¸ºè‰ç¨¿
          prerelease: false

      # ä¸Šä¼  Release ç›®å½•ä½œä¸º Artifact
      - name: ğŸ“¤ ä¸Šä¼  Release ç›®å½•
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: ${{ github.workspace }}/build/windows/x64/runner/Release
